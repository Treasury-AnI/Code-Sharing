%macro Creating_clean_corr;
proc sql;
Connect to sqlservr (server=WPRDSQL36\iLeed database=IDI_clean_&Version);

	create table COR as
		SELECT distinct 
		 snz_uid,
			input(cor_mmp_period_start_date,yymmdd10.) as startdate,
			input(cor_mmp_period_end_date, yymmdd10.) as enddate,
			cor_mmp_mmc_code,  
	    	(case when cor_mmp_mmc_code in ('PRISON','REMAND' ) then 'COR_Custody'
			     when cor_mmp_mmc_code in ('HD_SENT','HD_SENT', 'HD_rel' ) then 'COR_HD'
                 when cor_mmp_mmc_code in ('ESO','PAROLE','ROC','PDC' ) then 'COR_Post_Re'
				 when cor_mmp_mmc_code in ('COM_DET','CW','COM_PROG','COM_SERV' ,'OTH_COMM','INT_SUPER','SUPER','PERIODIC') then 'COR_Com'
                 else 'COR_OTHER' end) as sentence 
		FROM COR.ov_major_mgmt_periods 
		where snz_uid in (SELECT DISTINCT snz_uid FROM &population) 
		AND cor_mmp_mmc_code IN ('PRISON','REMAND','HD_SENT','HD_REL','ESO','PAROLE','ROC','PDC','PERIODIC',
			'COM_DET','CW','COM_PROG','COM_SERV','OTH_COMM','INT_SUPER','SUPER')

		ORDER BY snz_uid,startdate;
quit;

proc sql;
create table COR_1 as select
a.* ,
b.DOB
from COR a left join &population b
on a.snz_uid=b.snz_uid;

data COR_1 Del; set COR_1;
format startdate enddate date9.;

if startdate>"&sensor"d then delete;
if enddate>"&sensor"d then enddate="&sensor"d;

if startdate <intnx('YEAR',DOB,7,'S') then output del; else output  COR_1;
run;

%OVERLAP (COR_1); 

data CORR_clean; set COR_1_OR; run;

%mend;